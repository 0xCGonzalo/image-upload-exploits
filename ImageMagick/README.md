## ImageMagick attacks

ImageMagick is popular library for image processing. And this library has many vulnerabilities such as RCE, SSRF, Memory Leaks, DoS and others. Exploits work only if the web application uses vulnerable version of ImageMagick to process images, for example, resizes or frames using ImageMagick.

This section contains exploits for various vulnerabilities.

### Some useful tricks
1) If the application prohibits processing files with the extension that you need for one of the exploits (for example XBM, EPS) just try to change the extension to the allowed (PNG, JPEG). ImageMagick recognize the file format by it's content.
2) If you found memory leak vulnerability - try to automate exploataion. Write a script that will upload the images and then extract the leaked information, this will allow you to get different sections of memory in a short time, so that you can find sensitive data.

### ImageTragick 

The most famous bugs related to ImageMagick. 



### GhostScript

GhostScript is just an interpreter for PostScript. PostScript is a kind of programming language and most of exploits are affects sandboxing in PostScript. Vulnerabilities in GhostScript affects ImageMagick because it uses GhostScript for processing PostScript files like a PDF, EPS, PS, XPS. Of course, if you found a application that handling these file types without ImageMagick, you can also try these exploits.
In GhostScript section you can find RCE PoC for CVE-2017–8291 and CVE-2018–16509. 

**Don't forget to change DNS domain in dnsbased exploits**

[Exploits for CVE-2018-16509](GhostScript/CVE-2018–16509)

[Exploits for CVE-2017–8291](GhostScript/CVE-2017–8291)

You can modify these exploits to execute any commands, just open it in text editor.

**Links**
[Franz Rosen, Semrush BugBounty](https://hackerone.com/reports/403417)

### Gifoeb (CVE-2017-15277)

Memory leak due to an error in processing GIF images. This bug was discovered by Emil Lerner. He also created a [PoC](https://github.com/neex/gifoeb) that allows you to extract data from the resulted image. This vulnerability is often found in applications that allow you to upload images and then process them, for example, resize. Size of memory leakage is limited to 768 bytes.

You can use [300x300 GIF image](GIF_memory_leak/300x300.gif) file to detect if application is vulnerable for this. If application is vulnerable you will see something like:

![](GIF_memory_leak/result1.gif)
![](GIF_memory_leak/result2.gif)

then use Emil's [PoC](https://github.com/neex/gifoeb) for futher exploataion.

**Links**
[Eray Mitrani, Twitter BugBounty](https://hackerone.com/reports/315906)

### XBM memory leak (CVE-2018-16323)

Another memory leak. Vulnerability in processing XBM images. Same condition as in gifoeb, web application needs to proccess this images with ImageMagick, for example, resize. The vulnerability was discovered by Fedotkin Zakhar (d4d), he created a [PoC](https://github.com/d0ge/xbmdump).  Size of memory leakage is unlimited but environment dependent.

Also there is about this bug [article](https://medium.com/@ilja.bv/yet-another-memory-leak-in-imagemagick-or-how-to-exploit-cve-2018-16323-a60f048a1e12) wrote by me and @ttffdd, and alternative [PoC](https://github.com/ttffdd/XBadManners) by @ttffdd.

Exploits:

[Valid 500x500 XBM image](XBM_memory_leak/poc-500.xbm)
[Same as above with JPG extension](XBM_memory_leak/poc-500.jpg)

[500x500 image with short payload](XBM_memory_leak/poc-min.xbm)
[Same as above with JPG extension](XBM_memory_leak/poc-min.jpg)

If the web application is vulnerable, then the result will be similar to something like:

![](XBM_memory_leak/result1.png)
![](XBM_memory_leak/result2.png)

Then try to recover raw bytes with one of the tools. Or simply use imagemagick:
```
convert result1.png result1.xbm
```
In result1.xbm you will see raw bytes of memory as part of an array in XBM image.


###Some more interesting:
[JPG memory leak, YahooBleed#1](https://scarybeastsecurity.blogspot.com/2017/05/bleed-continues-18-byte-file-14k-bounty.html)

[JPG memory leak, YahooBleed#2](https://scarybeastsecurity.blogspot.com/2017/05/bleed-more-powerful-dumping-yahoo.html)

[PNG compression DoS](https://hackerone.com/reports/454)